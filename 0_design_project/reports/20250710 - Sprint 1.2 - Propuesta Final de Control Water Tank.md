---
created: 20250710 05:07
update: 20250727-07:35
summary: 
status: 
link: 
tags: 
---
# Guía Técnica de la Dinámica Water Tank

## 1. Declaración técnica del problema y supuestos

El objetivo es mantener la altura $h(t)$ del líquido en un estanque vertical en un valor de `setpoint` fijo $h^*$. Para ello el sistema permite manipular en serie dos actuadores en la entrada y en la salida. Donde, una válvula de entrada cuyo controlador PID genera un torque $\tau_v(t)$ que se convierte linealmente en un porcentaje de apertura $u(t) \in [0,1]$ que regula directamente el flujo hacia el estanque, además se cuenta con una bomba de entrada, cuyo controlador envía una tensión $V_{pi}(t)$ que se traduce en una apertura normalizada $u_{pi}(t)\in[0,1]$, pero que por ahora se mantendrá `cte`. A su vez, la válvula y la bomba de salida se mantienen en aperturas fijas $u_{\text{out}}$ y $u_{po}$ ; por lo que, por ahora **no** forman parte de la acción de control.

El tanque se modela como un cilindro de sección transversal constante $A$ [m²]. El fluido es incompresible, con densidad uniforme $\rho$ [kg·m⁻³], y se descartan variaciones de temperatura. El suministro llega desde una línea con presión constante $P_{\sup}$ [Pa]. La gravedad actúa con aceleración $g$ [m·s⁻²].

La dinámica se obtiene aplicando balance de masa. La tasa de cambio de volumen $A\,\mathrm d h/\mathrm d t$ es la diferencia entre los caudales másicos de entrada (válvula + bomba) y de salida (válvula + bomba):
$$
A\,\frac{\mathrm d h}{\mathrm d t}
=\dot m_{\mathrm{in}}(u,u_{pi})
-\dot m_{\mathrm{out}}(u_{\mathrm{out}},u_{po},h)
$$

donde cada término se define como:
- $\dot m_{\mathrm{in}}(u,u_{pi})$ es el caudal másico común de válvula y bomba de entrada en serie, tal que:
	- $\dot m_{\mathrm{in}}(u,u_{pi})=\rho\,Q^*(u,u_{pi})$ 
	- con $Q^*(u,u_{pi})$ satisfaciendo:
$$\Delta P_{pi}(Q^*,u_{pi})=\Delta P_{\rm val}(Q^*,u)$$
- $\dot m_{\mathrm{out}}(u_{\mathrm{out}},u_{po},h)$ es el caudal másico común de válvula y bomba de salida en serie, tal que:
	- $\dot m_{out}=\rho\,Q_{\rm out}^*(u_{\mathrm{out}},u_{po},h)$ con $Q_{\rm out}^*$ dado por:
$$\Delta P_{po}(Q_{\rm out}^*,u_{po}) =\Delta P_{\rm val,out}(Q_{\rm out}^*,u_{\mathrm{out}})$$
Se imponen límites físicos:

- $0\le h(t)\le H_{\max}$
- $0\le u(t),\,u_{pi}(t),\,u_{\text{out}},\,u_{po}\le1$

La condición inicial es $h(0)=h_0$ con $0<h_0<H_{\max}$.

En el simulador, la clase dinámica debe ofrecer:  
- `reset()`: asigna $h_0$.  
- `apply_action(u,u_pi,dt)`: calcula $\dot m_{\mathrm{in}}$ y $\dot m_{\mathrm{out}}$, integra sobre `dt` y devuelve el nuevo $h$.

**Variables y constantes**  

| Símbolo                                | Descripción                               | Unidad |
| -------------------------------------- | ----------------------------------------- | ------ |
| $h, h_0, H_{\max}$                     | Altura, inicial y máxima                  | m      |
| $A$                                    | Área transversal del tanque               | m²     |
| $\rho$                                 | Densidad del fluido                       | kg·m⁻³ |
| $g$                                    | Gravedad                                  | m·s⁻²  |
| $P_{\sup}$                             | Presión de suministro                     | Pa     |
| $C_d, C_{d,\text{out}}$                | Coeficientes de descarga (entrada/salida) | –      |
| $Q_{pi,\max},Q_{po,\max}$              | Caudales volumétricos máximos (bombas)    | m³·s⁻¹ |
| $u,\,u_{pi},\,u_{\text{out}},\,u_{po}$ | Aperturas normalizadas                    | –      |
| $\tau_v$                               | Torque aplicado a la válvula              | N·m    |
| $V_{p}$                                | Tensión de control de la bomba            | V      |

## 2. Origen fenomenológico y ecuaciones base
### 2.1 Principio de Bernoulli y conservación de energía
Aplicando el principio de Bernoulli entre el punto de suministro (antes de la válvula) y la superficie libre del tanque:

$$
P_{\sup} + \tfrac12\,\rho\,v_{\sup}^{2} + \rho\,g\,z_{\sup}
= P_{\mathrm{atm}} + \tfrac12\,\rho\,v^{2} + \rho\,g\,h
$$
Suponiendo:
- $v_{\sup}\approx0$ (línea de alimentación tiene sección mucho mayor al orificio),  
- $z_{\sup}=0$,  
- $P_{\mathrm{atm}}=0$ (referencia),  

se obtiene la presión diferencial disponible para el flujo:
$$
\Delta P 
= P_{\sup} - \rho\,g\,h
= \tfrac12\,\rho\,v^{2}
$$
y, usando la relación $Q = v\,(A_o\,u)$,  
$$
\Delta P = \tfrac12\,\rho\,
\Bigl(\frac{Q}{A_o\,u}\Bigr)^{2}
$$

### 2.2 Caída de presión en la válvula de entrada
La pérdida de carga en la válvula, que concentra efectos de turbulencia y recortes geométricos, se modela como:
$$
\Delta P_{\rm val}(Q,u)
= \frac{\rho}{2}\,
\Bigl(\frac{Q}{C_d\,A_o\,u}\Bigr)^{2}
$$
donde:
- \(C_d\) [–] es el coeficiente de descarga,
- \(A_o\) [m²] es el área de sección del orificio nominal,
- \(u\in[0,1]\) es la fracción de apertura.

### 2.3 Curva característica de la bomba de entrada
Se modela la bomba centrífuga con la relación cuadrática entre presión diferencial y caudal:

$$
\Delta P_{pi}(Q,u_{pi})
= \Delta P_{pi,\max}\,u_{pi}
\;-\;
K_{pi}\,Q^{2}
$$
donde:  
- $\Delta P_{pi,\max}$ [Pa] es la cabeza máxima a $u_{pi}=1$.  
- $K_{pi}$ [Pa·s²/m⁶] caracteriza la pendiente de la curva.  
- $Q$ [m³·s⁻¹] es el caudal en serie.

### 2.4 Equilibrio presión–caudal en serie (bomba – válvula de entrada)
Para flujo en serie, la presión generada por la bomba se iguala a la caída de presión en la válvula:
$$
\Delta P_{pi}(Q,u_{pi})
=
\Delta P_{\rm val}(Q,u)
$$
de donde se resuelve implícitamente $Q^*(u,u_{pi})$, tal que:
$$
Q^*_{\mathrm{in}}(u,u_{pi})
= \sqrt{ \, 
\frac{\Delta P_{pi,\max}\,u_{pi}}
{K_{pi} \;+\;\dfrac{2}{\rho\,\bigl(C_{d,in}\,A_{o,in}\,u\bigr)^{2}}}
}
$$

### 2.5 Caída de presión en la válvula de salida
Análoga a la entrada, la pérdida de carga en la válvula de salida es:
$$
\Delta P_{\rm val,out}(Q,u_{\rm out})
= \frac{\rho}{2}\,
\Bigl(\frac{Q}{C_{d,\mathrm{out}}\,A_{o,o}\,u_{\mathrm{out}}}\Bigr)^{2}
$$
con:
- $C_{d,\mathrm{out}}$ [–] coeficiente de descarga.  
- $A_{o,o}$ [m²] área del orificio de salida.  
- $u_{\mathrm{out}}\in[0,1]$ apertura fija.  

### 2.6 Curva característica de la bomba de salida
Se modela la bomba centrífuga de descarga con la relación cuadrática entre presión diferencial y caudal:
$$
\Delta P_{po}(Q,u_{po})
= \Delta P_{po,\max}\,u_{po}
\;-
\;K_{po}\,Q^{2}
$$
- $\Delta P_{po,\max}$ [Pa] cabeza máxima a $u_{po}=1$.
- $K_{po}$ [Pa·s²/m⁶] pendiente de la curva.
- $Q$ [m³·s⁻¹] caudal en serie.

### 2.7 Equilibrio presión–caudal en serie (bomba – válvula de salida)
Para flujo en serie, la presión generada por la bomba de salida se iguala a la caída de presión en la válvula de salida:
$$
\Delta P_{po}(Q,u_{po})
=
\Delta P_{\rm val,out}(Q,u_{\rm out})
$$
Además, considerando la presión generada por la columna de agua del estanque $P_{h} = \rho g h$ se determina implícitamente el caudal real de salida $Q_{\rm out}^*(u_{\rm out},u_{po},h)$, tal que:
$$
Q^*_{\mathrm{out}}(h,u_{\mathrm{out}},u_{po})
= \sqrt{ \,
  \frac{\rho\,g\,h \;+\;\Delta P_{po,\max}\,u_{po}}
       {K_{po} \;+\;\dfrac{2}{\rho\,\bigl(C_{d,\mathrm{out}}\,A_{o,\mathrm{out}}\,u_{\mathrm{out}}\bigr)^{2}}}
}
$$

### 2.8 Balance de masa volumétrico en el tanque
Aplicando balance de volumen en el tanque (entradas menos salidas):
$$
A\,\frac{\mathrm d h}{\mathrm d t}
= Q^*(u,u_{pi})
- Q_{\rm out}^*(u_{\rm out},u_{po},h)
$$

- $Q^*(u,u_{pi})$ [m³·s⁻¹] caudal de entrada real, resuelto en 2.4.
- $Q_{\rm out}^*(u_{\rm out},u_{po},h)$ [m³·s⁻¹] caudal de salida real, resuelto en 2.7.

Dividiendo por $A$ se obtiene $\dot h$ [m·s⁻¹].
